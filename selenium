Every selenium2 test => require property/test/selenium2_helper=>
require property/gems/selenium_testing/selenium_testing.rb =>
(module)require af_selenium =>
require setup_capybara, will register_driver =>
AfSelenium.environment.create_capybara_driver(app) =>
AfSelenium.environment will try to create a environment according to ENV, reutrn a SeleniumServerEnvironment =>
finally a Capybara::Selenium::Driver.new(app, options) will be created with options including selenium server address etc.




automationtestrunservlet

在aws上启动selenium-grid-scaler
在本地启动app，使用tunnel

在本地运行test（使用环境变量），将selenium server的位置指向aws，app的位置指向tunnel

selenium_host: ENV['SELENIUM_SERVER_HOST'] || 'localhost',
         selenium_port: ENV['SELENIUM_SERVER_PORT'] || 4444,
         capybara_host: ENV['APP_SERVER_HOST'] || 'localhost'


### bundle位置

         /etc/ssl/certs/ca-bundle.crt

### 本地运行测试
TEAM_CITY=true SELENIUM_SERVER_HOST=52.53.232.105 SELENIUM_SERVER_PORT=4444 APP_SERVER_HOST=3e302314.ngrok.io ruby -I test test/selenium2/accounting/application_fees_test.rb

### EC2: IP
52.53.232.105

### 登录EC2
ssh -i "/Users/appfolio/Downloads/aws-keypair-ysw.pem" ec2-user@ec2-52-53-232-105.us-west-1.compute.amazonaws.com
Last login: Mon Jul 18 18:12:48 2016 from 206-169-91-202.static.twtelecom.net

### EC2 iam setting
User Name,Access Key Id,Secret Access Key
"Test",AKIAJMYQMRPJSPEHH23A,mLRHtUfnrBeH/xtwEjDO4KnECJPzh/mqn3fbvP2P

### EC2 启动seleniumGridScaler:
java -DawsAccessKey=AKIAIIDKB556EHOSG6ZQ -DawsSecretKey=1UKk40jJuktlmgE1tq+sDYa+lJpl5c0hYGmm/S -DipAddress="52.53.232.105" -cp automation-grid.jar org.openqa.grid.selenium.GridLauncher -role hub -servlets "com.rmn.qa.servlet.AutomationTestRunServlet","com.rmn.qa.servlet.StatusServlet"


### EC2 启动grider，使用公司的credentials
java -DawsAccessKey=AKIAJ7V65GGBFGAFAB3Q -DawsSecretKey=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 -DipAddress="52.53.232.105" -cp automation-grid.jar org.openqa.grid.selenium.GridLauncher -role hub -servlets "com.rmn.qa.servlet.AutomationTestRunServlet","com.rmn.qa.servlet.StatusServlet"

ruby -I test test/selenium2/accounting/application_fees_test.rb

TEAM_CITY=true SELENIUM_SERVER_HOST=52.53.232.105 SELENIUM_SERVER_PORT=4444
APP_SERVER_HOST=3e302314.ngrok.io ruby -I test test/selenium2/accounting/application_fees_test.rb

将本机

require 'net/http'
require 'uri'

uri = URI.parse("https://api.rollbar.com/api/1/item/")
http = Net::HTTP.new(uri.host, uri.port)
request = Net::HTTP::Post.new(uri.request_uri)
request.set_form_data({"q" => "My query", "per_page" => "50"})



Flaky report test:
def generate_rollbar_message(klass, method_name, retry_counts, retry_elapsed_time)
          {
              'access_token': '631d2ce82b01472f8a5caeaaca6315ba',
              'data': {
                  'environment': 'testing',
                  'body': {
                      'message': {
                          'body': {:class => "#{klass.to_s}",
                                   :method_name => method_name.to_s,
                                   :retry_counts => retry_counts,
                                   :retry_time => "#{retry_elapsed_time} sec"}.to_json
                      }
                  },
                  'fingerprint': "#{klass.to_s}/#{method_name.to_s}",
                  'title': "#{klass.to_s}/#{method_name.to_s}"
              }
          }.to_json
        end
rollbar_api_endpoint = 'https://api.rollbar.com/api/1/item/'


AutomationTestRunServlet => runTimeHostName
AutomationConstant => IP_ADDRESS



curl -X GET -o RPM-GPG-KEY-lambda-epll https://lambda-linux.io/RPM-GPG-KEY-lambda-epll
sudo rpm --import RPM-GPG-KEY-lambda-epll
curl -X GET -o epll-release-2016.03-1.1.ll1.noarch.rpm https://lambda-linux.io/epll-release-2016.03-1.1.ll1.noarch.rpm
sudo yum -y install epll-release-2016.03-1.1.ll1.noarch.rpm
sudo yum --enablerepo=epll install firefox-compat
logout
ssh -X -i "/Users/appfolio/Downloads/aws-keypair-ysw.pem" ec2-user@ec2-52-53-232-105.us-west-1.compute.amazonaws.com
wget -O firefox.tar.bz2  "https://ftp.mozilla.org/pub/firefox/releases/45.0.1/linux-x86_64/en-US/firefox-45.0.1.tar.bz2"
bzcat firefox.tar.bz2 | tar xvf -

### SSH to cloudFormation instance
ssh -i "/Users/appfolio/Downloads/ysw.pem" centos@ec2-52-37-143-194.us-west-2.compute.amazonaws.com

### Start scaler on cloudFormation
java -DawsAccessKey=AKIAJ7V65GGBFGAFAB3Q -DawsSecretKey=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 -DipAddress="52.37.143.194" -cp automation-grid.jar org.openqa.grid.selenium.GridLauncher -role hub -servlets "com.rmn.qa.servlet.AutomationTestRunServlet","com.rmn.qa.servlet.StatusServlet"

### Start standalong on cloudFormation
java -jar /opt/selenium-server-standalone-2.53.0.jar -role node -hub http://52.37.143.194:4444/grid/register


### SSH to us-east-1 smalle instance
ssh -i "ysw.pem" ec2-user@ec2-54-165-217-95.compute-1.amazonaws.com

## Script
sudo yum install git
yum install -y python-pip

sudo yum install java-1.8.0
sudo yum remove java-1.7.0-openjdk

## Install ruby on centos
gpg --keyserver hkp://keys.gnupg.net --recv-keys 409B6B1796C275462A1703113804BB82D39DC0E3
curl -sSL https://get.rvm.io | bash -s stable --ruby
source /home/ec2-user/.rvm/scripts/rvm

//nodejs and npm, including updates
yum -y install nodejs
sudo npm cache clean -f
sudo npm install -g n
sudo n stable
sudo npm install -g npm
npm install

别忘了db:migrate

Current Issue:


http://hubIpAddress:4444/grid/admin/AutomationTestRunServlet?uuid=testRun1&threadCount=10&browser=chrome

[AwsVmManager] Use credentials: Key=AKIAJ7V65GGBFGAFAB3Q Secret=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


maxSession 同时能够运行的test最多是多少
每个capability有一个maxInstances，表示该capability的test最多能跑几个











* Each test running on the node will occupy a test slot.  A test slot can either be in use (have a session) or be
* available for scheduling (no associated session).  This method allows retrieving the total state of the node,
* both test slots in use and those unused.
